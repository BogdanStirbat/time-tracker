<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Time Tracker</title>
    <script src="/resources/js/angular.1.4.8.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/resources/css/style.css">
</head>
<body>
    <h2>Activities</h2>

    <div ng-app="timeTracker" ng-controller="activitiesTracker">
        <ul>
            <li ng-repeat="x in activities">
                {{x.activityName}} - {{x.hours}}h:{{x.minutes}}m <span
                    ng-click="removeActivity($index)">x</span>
            </li>
        </ul>

        <label>Total: </label> {{totalHours}}h:{{totalMinutes}}m
        
        <section>
            <h3>Add new Activity</h3>

            <label>Name: </label><input ng-model="newActivityName">

            <section>
                <p class="left">Time spent </p>

                <table class="time">
                    <tr>
                        <th><label>Hours: </label></th>
                        <th><input class="small" ng-model="newActivityHour"></th>
                    </tr>
                    <tr>
                        <th><label>Minutes:</label></th>
                        <th><input class="small" ng-model="newActivityMinute"></th>
                    </tr>
                </table>
            </section>
        </section>
        <label>Date: </label><input ng-model="newActivityDate">
        <br>
        <br>
        <div class="btn" ng-click="addActivity()">Add</div>
    </div>

    <script>
        var app = angular.module('timeTracker', []);
        app.controller('activitiesTracker', function($scope, $http) {
            $scope.newActivityDate = currentDate();
            loadTimeTrackReports();
            $scope.newActivityName = '';
            $scope.newActivityHour = '';
            $scope.newActivityMinute = '';
            $scope.totalHours = 0;
            $scope.totalMinutes = 0;

            $scope.addActivity = function() {
                name = $scope.newActivityName;
                hours = $scope.newActivityHour;
                minutes = $scope.newActivityMinute;
                if (hours == '') {
                    hours = 0;
                }
                if (minutes == '') {
                    minutes = 0;
                }
                $scope.newActivityName = '';
                $scope.newActivityHour = '';
                $scope.newActivityMinute = '';
                newActivity = {activityName: name, hours: hours, minutes: minutes, date: $scope.newActivityDate};
                $http.post('rest/report/add', newActivity)
                .then(function(response) {
                    if (response.data.success == true) {
                        newActivity.id = response.data.id;
                        $scope.activities.push(newActivity);
                        adjustTotalTime();
                    } else {
                        alert('An error occured adding time track report!');
                    }
                }, function(response) {
                    alert('An error occured adding time track report!');
                });
            }

            $scope.removeActivity = function(x) {
                $http.delete('rest/report/remove?id=' + $scope.activities[x].id)
                .then(function(response) {
                    if (response.data.success == true) {
                        $scope.activities.splice(x, 1);
                        adjustTotalTime();
                    } else {
                        alert('An error occured removing time track report!');
                    }
                }, function(response) {
                    alert('An error occured removing time track report!');
                });
            }

            function currentDate() {
                var date = new Date();
                return date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate();
            }

            function adjustTotalTime() {
                var hours = 0;
                var minutes = 0;
                for(var i = 0; i < $scope.activities.length; i++) {
                    var activity = $scope.activities[i];
                    hours += parseInt(activity.hours, 10);
                    minutes += parseInt(activity.minutes, 10);
                }
                $scope.totalHours = hours + Math.floor(minutes/60);
                $scope.totalMinutes = minutes % 60;
            }

            function loadTimeTrackReports() {
                $scope.activities = [];
                $http.get('rest/report/all/byDay?day=' + $scope.newActivityDate)
                .then(function(response) {
                    for (var i=0; i < response.data.length; i++) {
                        $scope.activities.push(response.data[i]);
                    }
                    adjustTotalTime();
                }, function(response) {
                    console.log('An error ocurred loading all time track reports.');
                    console.log(response);
                });

            }
        });
    </script>
</body>
</html>